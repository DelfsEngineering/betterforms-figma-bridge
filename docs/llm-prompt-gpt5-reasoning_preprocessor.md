# Figma to BetterForms Schema - Preprocessing Polish (GPT-5 Reasoning)

You are receiving a **draft BetterForms schema** generated by a JavaScript preprocessor. Polish and complete the conversion by addressing flagged issues and adding semantic improvements.

---

## Input Structure

```json
{
  "data": [...],              // Original Figma data (for context)
  "preprocessing": {
    "draftSchema": {...},     // Preprocessed schema (your starting point)
    "meta": {
      "issues": [             // What needs your attention
        "No autolayout on 'Card' - determine positioning",
        "IMAGE fill on 'Avatar' - convert to <img> tag"
      ]
    }
  }
}
```

---

<instructions>

## Task Overview

Your job is to:
1. **Fix all flagged issues** in the `meta.issues` array
2. **Add semantic improvements** (better naming, accessibility, HTML semantics)
3. **Preserve working conversions** from the draft schema
4. **Return only valid JSON** (no explanations, no markdown)

## BetterForms Field Types

### `type: "group"` - Containers
Use for frames, sections, layout containers. Has `fields` array for children.

```json
{
  "type": "group",
  "styleClasses": "flex flex-col gap-4 p-6 bg-white rounded-lg",
  "fields": [/* child elements */],
  "attributes": {
    "formGroup": {
      "data-idbf": "idbf_g_60_123"
    }
  },
  "BFName": "card_container"
}
```

### `type: "html"` - Custom HTML Content
Use for text, images, SVG graphics, shapes, custom form controls - anything not a button/input.

**Text example:**
```json
{
  "type": "html",
  "html": "<h1 class=\"text-2xl mb-4 text-gray-900 font-bold\">Welcome</h1>",
  "styleClasses": "mb-4 ",
  "attributes": {
    "formElement": {
      "data-idbf": "idbf_e_60_124"
    }
  },
  "BFName": "welcome_heading"
}
```

**SVG example:**
```json
{
  "type": "html",
  "html": "<svg width=\"24\" height=\"24\">...</svg>",
  "styleClasses": "w-6 h-6",
  "attributes": {
    "formElement": {
      "data-idbf": "idbf_e_60_125"
    }
  },
  "BFName": "icon_star"
}
```

**Common patterns:** Text (`<h1>`, `<p>`), images (`<img>`), SVG (preserve as-is), gradients (inline style), custom form controls (`<label><input>`)

### `type: "button"` - Interactive Buttons

**Required properties:** `text` (or `icon`), `buttonClasses`, `actions`, `styleClasses: "mb-0"`

**üö® IMPORTANT:** Margin must go in `styleClasses`, NOT in `buttonClasses`!

```json
{
  "type": "button",
  "text": "Submit",
  "buttonClasses": "px-4 py-2 bg-blue-600 text-white rounded",  // Visual styling only
  "actions": [],
  "styleClasses": "mb-0",  // ‚úÖ Margin goes here!
  "attributes": {"formElement": {"data-idbf": "idbf_e_60_126"}},
  "BFName": "submit_button"
}
```

**Icon button:**
```json
{"type": "button", "icon": "fa-regular fa-edit", "text": "", "actions": [], "buttonClasses": "p-[4px] w-[28px] h-[28px] rounded text-[#0c4a6e]", "styleClasses": "mb-0"}
```

### `type: "input"` / `type: "textArea"` - Form Inputs
**Use sparingly.** Only for simple text inputs. For checkboxes, radios, toggles ‚Üí use `type: "html"` with custom markup.

## Required Properties

Every field MUST have:
- `type` - One of: group, html, button, input, textArea
- `attributes` - **MUST be wrapped in `formGroup` (for groups) or `formElement` (for elements)**
- `BFName` - lowercase_with_underscores, max 50 chars, descriptive

### ‚ö†Ô∏è CRITICAL: `attributes` Structure

**BetterForms requires `data-idbf` to be wrapped in `formGroup` or `formElement`:**

‚úÖ **CORRECT for groups:**
```json
"attributes": {
  "formGroup": {
    "data-idbf": "idbf_g_abc123"
  }
}
```

‚úÖ **CORRECT for elements (html, button, input, textArea):**
```json
"attributes": {
  "formElement": {
    "data-idbf": "idbf_e_abc123"
  }
}
```

‚úÖ **With additional data attributes (like font-family):**
```json
"attributes": {
  "formElement": {
    "data-idbf": "idbf_e_abc123",
    "data-figma-font": "Helvetica"
  }
}
```

**Note:** `data-figma-font` tells you the original font. Use it appropriately:
- **"Font Awesome"** ‚Üí Convert ligature to icon class: `"edit"` ‚Üí `<i class="fa-regular fa-edit"></i>`
- **Regular fonts** ‚Üí Apply as inline style: `style="font-family: Helvetica, Arial, sans-serif"`
- **Always preserve** the `data-figma-font` attribute in output

‚ùå **WRONG - Missing wrapper:**
```json
"attributes": { "data-idbf": "idbf_e_abc123" }
```

**Note:** The preprocessor outputs flat `data-idbf` attributes. Your job is to wrap them in the correct `formGroup` or `formElement` object based on the element type.

</instructions>

---

<exploration>

## Using Figma Data for Context

The raw Figma data is provided for context when fixing issues. Use it to:

1. **For layout issues:** Analyze `absoluteTransform` arrays to determine positioning patterns
2. **For image issues:** Confirm `fills[].type === "IMAGE"` and get sizing
3. **For gradient issues:** Extract `fills[]` gradient data (stops, colors, transform)
4. **For semantic improvements:** Use `node.name` to infer purpose (e.g., "Hero Section", "CTA Button")

**Do not guess or invent values.** If the Figma data doesn't provide sufficient information for a fix, use reasonable defaults:
- **Images** ‚Üí Use appropriate placeholder service (NEVER use empty/broken src):
  - **Avatars/portraits**: `https://i.pravatar.cc/{size}` (e.g., 40, 100, 150)
  - **All other images**: `https://placehold.co/{width}x{height}?text={Descriptive+Text}`
    - Example: `https://placehold.co/400x300?text=Product+Image`
- **Gradients** ‚Üí Simple two-color linear gradients
- **Layouts** ‚Üí Flex-based layouts as fallback

</exploration>

---

<fix_patterns>

## Issue Resolution Patterns

### Issue Type 1: No Autolayout

**Pattern:** `"No autolayout on '[Name]' - LLM should determine positioning strategy"`

**Cause:** Figma node has `direction: "NONE"` - children are manually positioned.

**Resolution steps:**
1. Examine `absoluteTransform` for each child in Figma data
2. **Check for background layers first:**
   - Locked layers (especially named "BG" or "Background") ‚Üí likely background
   - Full-size elements (same dimensions as parent) ‚Üí likely background
   - If background detected ‚Üí Use z-index pattern (see Issue Type 3)
3. **Analyze element grouping by position:**
   - Group elements with similar X coordinates (¬±50px tolerance) ‚Üí vertical column
   - Group elements with similar Y coordinates (¬±50px tolerance) ‚Üí horizontal row
   - Multiple distinct X positions ‚Üí `flex flex-row` with child groups
   - Example: Text at X=100, Buttons at X=800 ‚Üí horizontal layout with left/right groups
4. Calculate implicit padding from child positions:
   - If ALL children have same X offset from parent ‚Üí add `pl-[Xpx]`
   - If ALL children have same Y offset from parent ‚Üí add `pt-[Ypx]`
   - If uniform on all sides ‚Üí use `p-[Xpx]`
5. Determine layout pattern:
   - Similar Y coords ‚Üí `flex flex-row`
   - Similar X coords ‚Üí `flex flex-col`
   - Grid alignment ‚Üí `grid grid-cols-N`
   - Background + content ‚Üí `relative` parent + background layering
6. Remove fixed height if content should flow naturally (use `min-h-[...]` instead)
7. Add child-specific positioning if needed

**Example - Testimonial Card:**
```json
// Figma Data Analysis:
// - Card: X=2609, Y=2285, Size: 360√ó404
// - Star Rating: X=2641, Y=2317 ‚Üí Offset: (32, 32)
// - Quote: X=2641, Y=2365 ‚Üí Offset: (32, 80)
// - People: X=2641, Y=2617 ‚Üí Offset: (32, 332)
// Pattern: All children 32px from left edge = implicit padding!

// Before (preprocessor output):
{"type": "group", "styleClasses": "w-[360px] h-[404px] bg-white rounded-[30px]", "fields": [...]}

// After (LLM adds layout + padding):
{"type": "group", "styleClasses": "w-[360px] bg-white rounded-[30px] flex flex-col gap-6 p-8", "fields": [...]}
// Changes:
// - Added: flex flex-col gap-6 (vertical layout)
// - Added: p-8 (32px ‚âà 2rem implicit padding)
// - Removed: h-[404px] (let content flow naturally)

// ‚ö†Ô∏è IMPORTANT: Child elements should NOT have margin-top/margin-bottom when parent has gap-X
// The gap property handles all spacing between children automatically!
```

---

### Issue Type 2: IMAGE Fills

**Pattern:** `"IMAGE fill on '[Name]' - convert to <img> tag"`

**Cause:** Node has `fill.type: "IMAGE"` - preprocessor cannot access image URL.

**Resolution:**
Replace placeholder HTML with `<img>` tag using appropriate placeholder service:

**For portraits/avatars (round/small images):**
```json
// Before:
{"type": "html", "html": "<!-- RECTANGLE: Avatar -->", "styleClasses": "w-[40px] h-[40px] rounded-[36px]"}

// After:
{"type": "html", "html": "<img src=\"https://i.pravatar.cc/40\" alt=\"User avatar\" class=\"w-full h-full object-cover\">", "styleClasses": "w-[40px] h-[40px] rounded-[36px] overflow-hidden", "attributes": {"formElement": {"data-idbf": "idbf_e_60_836"}}, "BFName": "user_avatar"}
```

**Pravatar URL Format:**
```
https://i.pravatar.cc/{size}
```
- Use the larger dimension (width or height) as size
- Examples: `/40`, `/100`, `/150`

**For all other images (photos, banners, backgrounds):**
```json
// Before:
{"type": "html", "html": "<!-- RECTANGLE: Featured Image -->", "styleClasses": "w-[1538px] h-[1085px]"}

// After:
{"type": "html", "html": "<img src=\"https://placehold.co/1538x1085?text=Featured+Image\" alt=\"Featured image\" class=\"w-full h-full object-cover\">", "styleClasses": "w-[1538px] h-[1085px] rounded-lg overflow-hidden", "attributes": {"formElement": {"data-idbf": "idbf_e_60_123"}}, "BFName": "featured_image"}
```

**Placehold.co URL Format:**
```
https://placehold.co/{width}x{height}?text={Descriptive+Text}
```

**Text Guidelines:**
- Use the Figma element name (e.g., "Featured+Image", "Product+Photo", "Hero+Banner")
- Keep it short and descriptive (2-3 words max)
- Use `+` for spaces in URLs
- Example: `?text=Product+Photo` or `?text=Hero+Image`

**Determining image type:**
- **Use Pravatar if:** Element name contains "avatar", "profile", "user", "photo" OR is round/circular OR small (< 200px)
- **Use Placehold.co for:** All other images (banners, cards, backgrounds, product images, etc.)

**Always:**
- Add `overflow-hidden` to styleClasses for rounded images
- Use `class="w-full h-full object-cover"` inside the `<img>` tag
- Add descriptive `alt` text based on the element name
- Include the element's `data-idbf` in attributes

---

### Issue Type 3: Background SVG/Gradients with Overlaid Content

**Pattern:** Large background SVG/gradient with text/buttons overlaid on top

**üö® CRITICAL - BetterForms wraps elements in divs which breaks natural stacking!**

**Required Approach - Use z-index:**
```json
{
  "type": "group",
  "BFName": "cta_section",
  "styleClasses": "relative w-[1440px] h-[420px] flex flex-col items-center justify-center gap-6 px-8 mb-0",
  "fields": [
    {
      "BFName": "cta_background_svg",
      "html": "<svg>...gradient...</svg>",
      "styleClasses": "absolute inset-0 w-full h-full z-0 mb-0",  // ‚Üê Add z-0
      "type": "html"
    },
    {"html": "<h2>Heading</h2>", "styleClasses": "relative text-white ... mb-0"},  // ‚Üê Add relative
    {"html": "<p>Text</p>", "styleClasses": "relative text-white ... mb-0"},      // ‚Üê Add relative
    {"type": "group", "styleClasses": "relative flex gap-4 mb-0", "fields": [...]}  // ‚Üê Add relative
  ]
}
```

**Why this is required:**
- BetterForms wraps each element in additional divs (`<div class="form-element">`, `<div class="field-wrap">`)
- These wrapper divs break natural DOM stacking order
- Without z-index, background covers content despite coming first
- Solution: Background gets `z-0`, content gets `relative` (creates stacking context above z-0)

**Pattern:**
1. Parent container ‚Üí Must have `relative`
2. Background element ‚Üí Add `absolute inset-0 z-0`
3. ALL content elements ‚Üí Add `relative` to their styleClasses
4. Content groups ‚Üí Also need `relative`

---

### Issue Type 4: Inline Gradients

**Pattern:** `"GRADIENT on '[Name]' - raw fills data provided for LLM"`

**Cause:** Node has gradient fill - needs inline CSS.

**Resolution:**
Extract gradient from Figma `fills` array and convert to CSS:

```json
// Figma data shows:
{"fills": [{"type": "GRADIENT_LINEAR", "gradientStops": [{"color": "#0ea5e9", "position": 0}, {"color": "#0284c7", "position": 1}]}]}

// After:
{"type": "html", "html": "<div style=\"background: linear-gradient(90deg, #0ea5e9 0%, #0284c7 100%); width: 100%; height: 100%;\"></div>", "styleClasses": "w-[1440px] h-[420px] mb-0", "BFName": "gradient_background"}
```

---

### Issue Type 5: Text Color Requirements

**üö® CRITICAL - BetterForms has default text styling that must be overridden!**

**Pattern:** Text elements must have explicit text color classes

**Problem:** BetterForms applies default CSS that can make text unreadable (e.g., dark text on dark backgrounds)

**Solution:** ALWAYS include explicit text color classes on text elements:

```json
// ‚ùå WRONG - No text color:
{"html": "<h1>Welcome</h1>", "styleClasses": "text-[52px] font-bold"}

// ‚úÖ CORRECT - Explicit text color:
{"html": "<h1>Welcome</h1>", "styleClasses": "text-[52px] font-bold text-white"}
{"html": "<p>Description</p>", "styleClasses": "text-[18px] text-[#2d2f31]"}
```

**Required for ALL text elements:**
- Headings: `<h1>`, `<h2>`, `<h3>` ‚Üí Must have `text-white`, `text-gray-900`, `text-[#color]`
- Paragraphs: `<p>` ‚Üí Must have text color class
- Spans: `<span>` ‚Üí Must have text color class
- Even if text is inside buttons or other components

**Use Tailwind classes, NOT inline styles:**
- ‚úÖ `styleClasses: "text-white"`
- ‚úÖ `styleClasses: "text-[#2d2f31]"`
- ‚ùå `html: "<h1 style=\"color: #ffffff\">"`

---

### Issue Type 6: Prefer Tailwind Presets Over Arbitrary Values

**Pattern:** Use Tailwind preset classes instead of arbitrary values when they exist

**Solution:** Replace arbitrary values with Tailwind presets when there's an exact match (e.g., `bg-[#ffffff]` ‚Üí `bg-white`, `text-[#000000]` ‚Üí `text-black`). Only use arbitrary values `[...]` for custom colors/sizes that don't have presets.

---

### Enhancement: Semantic Improvements

Apply even if not flagged: Better BFName values (e.g., `"Frame 123"` ‚Üí `"card_container"`), semantic HTML tags (`<h1>`, `<p>`, `<blockquote>`), accessibility (`alt`, `aria-label`, heading hierarchy)

**Better BFName values:**
- `"Name"` ‚Üí `"customer_name"`
- `"Text"` ‚Üí `"description_text"` or `"heading_title"`
- `"Frame 123"` ‚Üí `"card_container"` or `"hero_section"`

**Semantic HTML tags:**
- Large bold text ‚Üí `<h1>`, `<h2>`, `<h3>`
- Body text ‚Üí `<p>`
- Quotes ‚Üí `<blockquote>`
- Lists ‚Üí `<ul>` + `<li>`

**Accessibility:**
- Images ‚Üí add `alt` attributes
- Icon buttons ‚Üí add `aria-label`
- Maintain heading hierarchy

**Button detection and flattening:**

When you see nested groups that are clearly buttons, **flatten them to `type: "button"`**:

```json
// Before (nested icon button groups from preprocessor):
{"type": "group", "BFName": "icon_button_edit", "fields": [
  {"type": "group", "fields": [
    {"html": "<i class=\"fa-regular fa-edit\"></i>"}
  ]}
]}

// After (flattened to button):
{"type": "button", "icon": "fa-regular fa-edit", "text": "", "actions": [], "buttonClasses": "p-[4px] w-[28px] h-[28px] rounded text-[#0c4a6e]", "styleClasses": "mb-0"}
```

**Extract the icon from nested HTML and move styling to buttonClasses.**

</fix_patterns>

---

<persistence>

## Task Completion

- Work through ALL issues in the `meta.issues` array systematically
- Apply semantic enhancements throughout the schema
- Only stop when:
  - All flagged issues are resolved
  - Semantic improvements are applied
  - Output is valid JSON
- Do NOT stop to ask clarifying questions - use reasonable defaults based on Figma data
- Do NOT explain your changes - return only the final JSON schema

</persistence>

---

<efficiency>

## Optimization

- **Draft schema is your starting point** - do not rebuild from scratch
- **Preserve working conversions** - only modify what needs fixing
- **Batch similar fixes** - handle all image issues together, all layout issues together
- **Validate as you go** - ensure JSON remains valid after each change

## Spacing Best Practices

### üö® CRITICAL: Margin Management

**BetterForms has legacy CSS that adds default `margin-bottom` to all elements.**

**The preprocessor adds `mb-0` to all elements by default.** You should:
- ‚úÖ **Preserve `mb-0`** when no spacing needed (most cases)
- ‚úÖ **Change to `mb-[X]`** when specific spacing is required
- ‚úÖ **Use `my-[X]` or `m-[X]`** for vertical/all margins
- ‚ùå **NEVER remove margin classes entirely** - legacy CSS will interfere

```json
// Draft from preprocessor (has mb-0 by default):
{"html": "Quote", "styleClasses": "text-[24px] mb-0"}

// Keep as-is if no special spacing needed:
{"html": "Quote", "styleClasses": "text-[24px] mb-0"}  // ‚úÖ

// OR change if specific spacing needed:
{"html": "Quote", "styleClasses": "text-[24px] mb-4"}  // ‚úÖ

// DO NOT remove margin class:
{"html": "Quote", "styleClasses": "text-[24px]"}  // ‚ùå Legacy CSS interferes!
```

### Background Layering Requires Z-Index

**üö® CRITICAL:** For background elements (SVG/gradients) with overlaid content, z-index IS required because BetterForms wraps each element in additional divs that break natural DOM stacking order. See Issue Type 3 for the required pattern.

---

### Font Awesome Icons

If `data-figma-font` contains "Font Awesome", convert ligature to FA class (e.g., `"edit"` ‚Üí `<i class="fa-regular fa-edit"></i>`).

</efficiency>

---

<validation>

## Output Requirements

**üö® CRITICAL: Return a SINGLE root element (object) starting with `{` and ending with `}`**

The root must be a complete BetterForms element (not wrapped in arrays or extra objects). If draft has multiple top-level fields, wrap in a group.

**‚úÖ CORRECT:** Single object with `type`, `BFName`, `styleClasses`, `attributes` (wrapped in `formGroup`/`formElement`)

### ‚úÖ CORRECT - Button Group Example:

```json
{
  "type": "group",
  "BFName": "button_group",
  "styleClasses": "flex flex-row gap-6",
  "attributes": {
    "formGroup": {
      "data-idbf": "idbf_g_..."
    }
  },
  "fields": [
    {
      "type": "button",
      "BFName": "btn_get_started",
      "text": "Get Started",
      "buttonClasses": "...",
      "attributes": {
        "formElement": {
          "data-idbf": "idbf_e_..."
        }
      }
    },
    {
      "type": "button",
      "BFName": "btn_demo",
      "text": "Request Demo",
      "buttonClasses": "...",
      "attributes": {
        "formElement": {
          "data-idbf": "idbf_e_..."
        }
      }
    }
  ]
}
```

### ‚úÖ CORRECT - Single Text Element:

```json
{
  "type": "html",
  "BFName": "welcome_heading",
  "html": "<h1>Welcome!</h1>",
  "styleClasses": "text-4xl font-bold text-gray-900",
  "attributes": {
    "formElement": {
      "data-idbf": "idbf_e_..."
    }
  }
}
```

### ‚ùå WRONG - Wrapped in Array:

```json
[
  {
    "type": "group",
    "fields": [...]
  }
]
```

### ‚ùå WRONG - Extra Wrapper Object:

```json
{
  "schema": { "fields": [...] }
}
```

### ‚ùå WRONG - Attributes WITHOUT Wrapper Objects:

```json
{
  "type": "group",
  "BFName": "my_group",
  "attributes": { "data-idbf": "idbf_g_123" },
  "fields": [...]
}
```

**Correct version (MUST wrap in formGroup/formElement):**
```json
{
  "type": "group",
  "BFName": "my_group",
  "attributes": {
    "formGroup": {
      "data-idbf": "idbf_g_123"
    }
  },
  "fields": [...]
}
```

---

### Requirements Checklist:

1. Single JSON object starting with `{` and ending with `}`
2. Every element has: `type`, `BFName`, `styleClasses`, `attributes` (wrapped in `formGroup`/`formElement`)
3. Preserve/modify margin classes (draft has `mb-0` - keep or change as needed)
4. Address all issues from `meta.issues`
5. Preserve structure from draft
6. Use semantic HTML and accessibility features
7. Return ONLY JSON (no explanations or markdown)

</validation>

---

## Execute Task

**Figma Data (for context):**
{{$figmaData}}

**Draft Schema (your starting point):**
{{$draftSchema}}

**Issues to Address:**
{{$issues}}

---

**üö® CRITICAL: BEGIN RESPONSE WITH `{` AND END WITH `}`**

Return a single, complete BetterForms element. Process the draft schema, fix all issues, add semantic improvements, and return ONLY the final JSON object.
