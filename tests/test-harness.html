<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Figma2BF Test Harness</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      margin-bottom: 20px;
      color: #1f2937;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .controls h2 {
      font-size: 16px;
      margin-bottom: 12px;
      color: #374151;
    }
    .file-input-wrapper {
      display: inline-block;
      position: relative;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    .file-input-wrapper label {
      display: inline-block;
      padding: 10px 16px;
      background: #0369a1;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .file-input-wrapper label:hover {
      background: #075985;
    }
    .drop-zone {
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      color: #64748b;
      margin-bottom: 16px;
      transition: all 0.2s;
    }
    .drop-zone.dragover {
      border-color: #0369a1;
      background: #f0f9ff;
    }
    .test-results {
      display: grid;
      gap: 20px;
    }
    .test-case {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .test-case.pass {
      border-left: 4px solid #10b981;
    }
    .test-case.fail {
      border-left: 4px solid #ef4444;
    }
    .test-case.manual {
      border-left: 4px solid #f59e0b;
    }
    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    .test-title {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    .test-meta {
      font-size: 12px;
      color: #6b7280;
    }
    .test-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .test-badge.pass {
      background: #d1fae5;
      color: #065f46;
    }
    .test-badge.fail {
      background: #fee2e2;
      color: #991b1b;
    }
    .test-badge.manual {
      background: #fef3c7;
      color: #92400e;
    }
    .test-section {
      margin-bottom: 16px;
    }
    .test-section h3 {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    .code-block {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 12px;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 11px;
      overflow-x: auto;
      max-height: 300px;
      overflow-y: auto;
    }
    .metrics {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    .metric {
      flex: 1;
      padding: 12px;
      background: #f9fafb;
      border-radius: 6px;
      text-align: center;
    }
    .metric-label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .metric-value {
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
    }
    .issues-list {
      list-style: none;
      padding: 0;
    }
    .issues-list li {
      padding: 6px 12px;
      background: #fef3c7;
      border-left: 3px solid #f59e0b;
      margin-bottom: 6px;
      border-radius: 3px;
      font-size: 12px;
      color: #92400e;
    }
    .diff {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .diff-col h4 {
      font-size: 12px;
      margin-bottom: 8px;
      color: #6b7280;
    }
    .actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .btn {
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      color: #374151;
    }
    .btn:hover {
      background: #f9fafb;
    }
    .btn-primary {
      background: #0369a1;
      color: white;
      border-color: #0369a1;
    }
    .btn-primary:hover {
      background: #075985;
    }
    .summary {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .summary-item {
      flex: 1;
      text-align: center;
    }
    .summary-item .label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .summary-item .value {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Figma2BF Test Harness</h1>
    
    <div class="controls">
      <h2>Load Test Cases</h2>
      <div class="drop-zone" id="dropZone">
        üìÇ Drag & drop test case JSON files here<br>
        <small style="color: #9ca3af; margin-top: 8px; display: block;">or click below to browse</small>
      </div>
      <div class="file-input-wrapper">
        <input type="file" id="fileInput" accept=".json" multiple>
        <label for="fileInput">Choose Files</label>
      </div>
      <button class="btn btn-primary" onclick="runAllTests()" id="runAllBtn" style="margin-left: 12px;" disabled>‚ñ∂Ô∏è Run Preprocessor Tests</button>
      <button class="btn" onclick="clearResults()">üóëÔ∏è Clear Results</button>
      
      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
        <h3 style="font-size: 14px; margin-bottom: 8px; color: #374151;">LLM Testing</h3>
        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
          <input type="text" id="apiKey" placeholder="BetterForms API Key" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;">
          <input type="text" id="apiEndpoint" value="https://appdev.fmbetterforms.com/api/v1/figma" style="flex: 2; min-width: 300px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;">
          <button class="btn btn-primary" onclick="runLLMTests()" id="runLLMBtn" disabled>ü§ñ Test Against LLM</button>
        </div>
        <p style="font-size: 11px; color: #6b7280; margin-top: 8px;">
          Re-sends test cases to the API to test prompt changes. Results will show diffs from original output.
        </p>
      </div>
    </div>

    <div class="summary" id="summary" style="display: none;">
      <div class="summary-item">
        <div class="label">Total Tests</div>
        <div class="value" id="totalTests">0</div>
      </div>
      <div class="summary-item">
        <div class="label">Passed</div>
        <div class="value" style="color: #10b981;" id="passedTests">0</div>
      </div>
      <div class="summary-item">
        <div class="label">Failed</div>
        <div class="value" style="color: #ef4444;" id="failedTests">0</div>
      </div>
      <div class="summary-item">
        <div class="label">Manual Review</div>
        <div class="value" style="color: #f59e0b;" id="manualTests">0</div>
      </div>
    </div>

    <div class="test-results" id="results">
      <div class="empty-state">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <p>No test cases loaded yet.</p>
        <p style="font-size: 12px; margin-top: 8px;">Load test cases from the plugin using "üíæ Save Test Case"</p>
      </div>
    </div>
  </div>

  <script src="preprocessor.js"></script>
  <script>
    let testCases = []
    let results = []
    let llmResults = []

    // File drop handling
    const dropZone = document.getElementById('dropZone')
    const fileInput = document.getElementById('fileInput')
    const apiKeyInput = document.getElementById('apiKey')
    const apiEndpointInput = document.getElementById('apiEndpoint')

    // Enable LLM test button when API key is entered
    apiKeyInput.addEventListener('input', () => {
      document.getElementById('runLLMBtn').disabled = !apiKeyInput.value || testCases.length === 0
    })

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault()
      dropZone.classList.add('dragover')
    })

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover')
    })

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault()
      dropZone.classList.remove('dragover')
      handleFiles(e.dataTransfer.files)
    })

    dropZone.addEventListener('click', () => {
      fileInput.click()
    })

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files)
    })

    async function handleFiles(files) {
      const jsonFiles = Array.from(files).filter(f => f.name.endsWith('.json'))
      
      if (jsonFiles.length === 0) {
        alert('Please select JSON files')
        return
      }

      for (const file of jsonFiles) {
        try {
          const text = await file.text()
          const testCase = JSON.parse(text)
          testCases.push(testCase)
        } catch (err) {
          console.error('Failed to load', file.name, err)
        }
      }

      document.getElementById('runAllBtn').disabled = testCases.length === 0
      document.getElementById('runLLMBtn').disabled = !apiKeyInput.value || testCases.length === 0
      renderEmptyOrResults()
    }

    async function runLLMTests() {
      const apiKey = apiKeyInput.value
      const endpoint = apiEndpointInput.value

      if (!apiKey) {
        alert('Please enter an API key')
        return
      }

      llmResults = []
      const btn = document.getElementById('runLLMBtn')
      btn.disabled = true
      btn.textContent = '‚è≥ Testing...'

      for (let i = 0; i < testCases.length; i++) {
        const testCase = testCases[i]
        btn.textContent = `‚è≥ Testing ${i + 1}/${testCases.length}...`
        
        try {
          const llmResult = await runLLMTest(testCase, apiKey, endpoint)
          llmResults.push(llmResult)
        } catch (err) {
          llmResults.push({
            testCase,
            error: err.message,
            status: 'fail'
          })
        }
      }

      btn.disabled = false
      btn.textContent = 'ü§ñ Test Against LLM'
      renderLLMResults()
    }

    async function runLLMTest(testCase, apiKey, endpoint) {
      const startTime = performance.now()

      // Strip preview images from source data to match plugin behavior
      const strippedData = JSON.parse(JSON.stringify(testCase.source.figmaData))
      stripBase64Data(strippedData)

      // Prepare request payload (matching plugin's sendToBetterForms)
      const requestBody = {
        apiKey: apiKey,
        type: testCase.request.type || 'element',
        elementName: testCase.elementName || '',
        data: strippedData,
        tokens: testCase.source.tokens,
        preprocessing: testCase.request.preprocessing
      }

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
      })

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${await response.text()}`)
      }

      const newOutput = await response.json()
      const endTime = performance.now()
      const processingTime = Math.round(endTime - startTime)

      // Compare with original output
      const differences = compareLLMOutputs(testCase.response, newOutput)

      return {
        testCase,
        newOutput,
        differences,
        processingTime,
        status: differences.length === 0 ? 'pass' : 'changed'
      }
    }

    function stripBase64Data(nodes) {
      if (!Array.isArray(nodes)) return
      for (const node of nodes) {
        if (node.previewUrl) delete node.previewUrl
        if (node.children) stripBase64Data(node.children)
      }
    }

    function compareLLMOutputs(oldOutput, newOutput) {
      const differences = []

      // Compare keys at top level
      const oldKeys = Object.keys(oldOutput || {})
      const newKeys = Object.keys(newOutput || {})

      for (const key of oldKeys) {
        if (!newKeys.includes(key)) {
          differences.push(`Removed key: "${key}"`)
        }
      }

      for (const key of newKeys) {
        if (!oldKeys.includes(key)) {
          differences.push(`Added key: "${key}"`)
        }
      }

      // Compare meta if exists
      if (oldOutput.meta && newOutput.meta) {
        if (oldOutput.meta.model !== newOutput.meta.model) {
          differences.push(`Model changed: ${oldOutput.meta.model} ‚Üí ${newOutput.meta.model}`)
        }
        if (oldOutput.meta.route !== newOutput.meta.route) {
          differences.push(`Route changed: ${oldOutput.meta.route} ‚Üí ${newOutput.meta.route}`)
        }
      }

      // Deep schema comparison would be complex, so just note if structure changed
      const oldStr = JSON.stringify(oldOutput.schema || oldOutput)
      const newStr = JSON.stringify(newOutput.schema || newOutput)
      if (oldStr !== newStr) {
        differences.push(`Schema structure changed (${oldStr.length} ‚Üí ${newStr.length} chars)`)
      }

      return differences
    }

    async function runAllTests() {
      results = []
      
      for (const testCase of testCases) {
        const result = await runTest(testCase)
        results.push(result)
      }

      renderResults()
    }

    async function runTest(testCase) {
      const startTime = performance.now()
      
      // Run preprocessor on source data
      const preprocessorOutput = await window.preprocessSelection(
        testCase.source.figmaData,
        testCase.source.tokens
      )

      const endTime = performance.now()
      const processingTime = Math.round(endTime - startTime)

      // Compare with expected output (if available)
      let status = 'manual' // Default to manual review
      let differences = []

      if (testCase.preprocessorResult) {
        // Compare complexity scores
        if (preprocessorOutput.meta.complexityScore !== testCase.preprocessorResult.meta.complexityScore) {
          differences.push(`Complexity score changed: ${testCase.preprocessorResult.meta.complexityScore} ‚Üí ${preprocessorOutput.meta.complexityScore}`)
        }

        // Compare recommended routes
        if (preprocessorOutput.meta.recommendedRoute !== testCase.preprocessorResult.meta.recommendedRoute) {
          differences.push(`Route changed: ${testCase.preprocessorResult.meta.recommendedRoute} ‚Üí ${preprocessorOutput.meta.recommendedRoute}`)
        }

        // Compare issues count
        const oldIssuesCount = testCase.preprocessorResult.meta.issues?.length || 0
        const newIssuesCount = preprocessorOutput.meta.issues?.length || 0
        if (oldIssuesCount !== newIssuesCount) {
          differences.push(`Issues count changed: ${oldIssuesCount} ‚Üí ${newIssuesCount}`)
        }

        status = differences.length === 0 ? 'pass' : 'fail'
      }

      return {
        testCase,
        preprocessorOutput,
        status,
        differences,
        processingTime
      }
    }

    function renderEmptyOrResults() {
      if (testCases.length === 0) {
        renderEmpty()
      } else if (results.length > 0) {
        renderResults()
      } else {
        document.getElementById('results').innerHTML = `
          <div class="empty-state">
            <p>${testCases.length} test case(s) loaded.</p>
            <p style="font-size: 12px; margin-top: 8px;">Click "‚ñ∂Ô∏è Run All Tests" to execute.</p>
          </div>
        `
      }
    }

    function renderEmpty() {
      document.getElementById('results').innerHTML = `
        <div class="empty-state">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p>No test cases loaded yet.</p>
          <p style="font-size: 12px; margin-top: 8px;">Load test cases from the plugin using "üíæ Save Test Case"</p>
        </div>
      `
      document.getElementById('summary').style.display = 'none'
    }

    function renderResults() {
      const passCount = results.filter(r => r.status === 'pass').length
      const failCount = results.filter(r => r.status === 'fail').length
      const manualCount = results.filter(r => r.status === 'manual').length

      document.getElementById('summary').style.display = 'flex'
      document.getElementById('totalTests').textContent = results.length
      document.getElementById('passedTests').textContent = passCount
      document.getElementById('failedTests').textContent = failCount
      document.getElementById('manualTests').textContent = manualCount

      const resultsHTML = results.map((result, idx) => {
        const badgeClass = result.status
        const badgeText = result.status === 'manual' ? 'Review' : result.status
        
        return `
          <div class="test-case ${result.status}">
            <div class="test-header">
              <div>
                <div class="test-title">${result.testCase.elementName || 'Untitled'}</div>
                <div class="test-meta">${new Date(result.testCase.timestamp).toLocaleString()}</div>
              </div>
              <span class="test-badge ${badgeClass}">${badgeText}</span>
            </div>

            <div class="metrics">
              <div class="metric">
                <div class="metric-label">Complexity</div>
                <div class="metric-value">${result.preprocessorOutput.meta.complexityScore}</div>
              </div>
              <div class="metric">
                <div class="metric-label">Route</div>
                <div class="metric-value" style="font-size: 14px; text-transform: uppercase;">${result.preprocessorOutput.meta.recommendedRoute}</div>
              </div>
              <div class="metric">
                <div class="metric-label">Issues</div>
                <div class="metric-value">${result.preprocessorOutput.meta.issues?.length || 0}</div>
              </div>
              <div class="metric">
                <div class="metric-label">Time</div>
                <div class="metric-value" style="font-size: 14px;">${result.processingTime}ms</div>
              </div>
            </div>

            ${result.differences.length > 0 ? `
              <div class="test-section">
                <h3>‚ö†Ô∏è Differences Detected</h3>
                <ul class="issues-list">
                  ${result.differences.map(d => `<li>${d}</li>`).join('')}
                </ul>
              </div>
            ` : ''}

            ${result.preprocessorOutput.meta.issues && result.preprocessorOutput.meta.issues.length > 0 ? `
              <div class="test-section">
                <h3>üîç Issues Flagged for LLM</h3>
                <ul class="issues-list">
                  ${result.preprocessorOutput.meta.issues.map(i => `<li>${i}</li>`).join('')}
                </ul>
              </div>
            ` : ''}

            <div class="test-section">
              <h3>üìä Preprocessor Output</h3>
              <div class="code-block">${JSON.stringify(result.preprocessorOutput.draftSchema, null, 2)}</div>
            </div>

            ${result.testCase.response ? `
              <div class="test-section">
                <h3>ü§ñ LLM Output</h3>
                <div class="code-block">${JSON.stringify(result.testCase.response, null, 2)}</div>
              </div>
            ` : ''}

            <div class="actions">
              <button class="btn" onclick="copyToClipboard(${idx}, 'source')">Copy Source</button>
              <button class="btn" onclick="copyToClipboard(${idx}, 'preprocessor')">Copy Preprocessor Output</button>
              ${result.testCase.response ? `<button class="btn" onclick="copyToClipboard(${idx}, 'llm')">Copy LLM Output</button>` : ''}
            </div>
          </div>
        `
      }).join('')

      document.getElementById('results').innerHTML = resultsHTML
    }

    function copyToClipboard(idx, type) {
      const result = results[idx]
      let data
      
      if (type === 'source') {
        data = result.testCase.source
      } else if (type === 'preprocessor') {
        data = result.preprocessorOutput
      } else if (type === 'llm') {
        data = result.testCase.response
      }

      const jsonString = JSON.stringify(data, null, 2)
      navigator.clipboard.writeText(jsonString).then(() => {
        alert('Copied to clipboard!')
      })
    }

    function renderLLMResults() {
      const passCount = llmResults.filter(r => r.status === 'pass').length
      const changedCount = llmResults.filter(r => r.status === 'changed').length
      const failCount = llmResults.filter(r => r.status === 'fail').length

      document.getElementById('summary').style.display = 'flex'
      document.getElementById('totalTests').textContent = llmResults.length
      document.getElementById('passedTests').textContent = passCount
      document.getElementById('failedTests').textContent = failCount
      document.getElementById('manualTests').textContent = changedCount
      document.querySelector('#manualTests').parentElement.querySelector('.label').textContent = 'Changed'

      const resultsHTML = llmResults.map((result, idx) => {
        const badgeClass = result.status === 'changed' ? 'manual' : result.status
        const badgeText = result.status === 'changed' ? 'Schema Changed' : result.status
        
        return `
          <div class="test-case ${result.status === 'changed' ? 'manual' : result.status}">
            <div class="test-header">
              <div>
                <div class="test-title">ü§ñ ${result.testCase.elementName || 'Untitled'}</div>
                <div class="test-meta">LLM Test - ${new Date().toLocaleString()}</div>
              </div>
              <span class="test-badge ${badgeClass}">${badgeText}</span>
            </div>

            ${result.error ? `
              <div class="test-section">
                <h3>‚ùå Error</h3>
                <div style="padding: 12px; background: #fee2e2; border-left: 3px solid #ef4444; border-radius: 3px; font-size: 12px; color: #991b1b;">
                  ${result.error}
                </div>
              </div>
            ` : `
              <div class="metrics">
                <div class="metric">
                  <div class="metric-label">Processing Time</div>
                  <div class="metric-value" style="font-size: 16px;">${result.processingTime}ms</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Changes</div>
                  <div class="metric-value">${result.differences.length}</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Model</div>
                  <div class="metric-value" style="font-size: 12px;">${result.newOutput.meta?.model || 'N/A'}</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Route</div>
                  <div class="metric-value" style="font-size: 12px; text-transform: uppercase;">${result.newOutput.meta?.route || 'N/A'}</div>
                </div>
              </div>

              ${result.differences.length > 0 ? `
                <div class="test-section">
                  <h3>üîÑ Detected Changes</h3>
                  <ul class="issues-list">
                    ${result.differences.map(d => `<li>${d}</li>`).join('')}
                  </ul>
                </div>
              ` : `
                <div class="test-section">
                  <h3>‚úÖ No Changes</h3>
                  <p style="font-size: 12px; color: #6b7280;">Output matches original test case.</p>
                </div>
              `}

              <div class="test-section">
                <h3>üìä Output Comparison</h3>
                <div class="diff">
                  <div class="diff-col">
                    <h4>Original Output</h4>
                    <div class="code-block">${JSON.stringify(result.testCase.response, null, 2)}</div>
                  </div>
                  <div class="diff-col">
                    <h4>New Output</h4>
                    <div class="code-block">${JSON.stringify(result.newOutput, null, 2)}</div>
                  </div>
                </div>
              </div>
            `}

            <div class="actions">
              <button class="btn" onclick="copyLLMResult(${idx}, 'old')">Copy Original</button>
              <button class="btn" onclick="copyLLMResult(${idx}, 'new')">Copy New Output</button>
              <button class="btn" onclick="copyLLMResult(${idx}, 'diff')">Copy Differences</button>
            </div>
          </div>
        `
      }).join('')

      document.getElementById('results').innerHTML = resultsHTML
    }

    function copyLLMResult(idx, type) {
      const result = llmResults[idx]
      let data

      if (type === 'old') {
        data = result.testCase.response
      } else if (type === 'new') {
        data = result.newOutput
      } else if (type === 'diff') {
        data = {
          testCase: result.testCase.elementName,
          timestamp: new Date().toISOString(),
          differences: result.differences,
          oldOutput: result.testCase.response,
          newOutput: result.newOutput
        }
      }

      const jsonString = JSON.stringify(data, null, 2)
      navigator.clipboard.writeText(jsonString).then(() => {
        alert('Copied to clipboard!')
      })
    }

    function clearResults() {
      if (confirm('Clear all loaded test cases and results?')) {
        testCases = []
        results = []
        llmResults = []
        fileInput.value = ''
        apiKeyInput.value = ''
        document.getElementById('runAllBtn').disabled = true
        document.getElementById('runLLMBtn').disabled = true
        renderEmpty()
      }
    }
  </script>
</body>
</html>

