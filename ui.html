<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BetterForms Figma Bridge</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font: 12px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: #111827; }
    .header { background: #ffffff; border-bottom: 1px solid #e5e7eb; padding: 12px; display: flex; align-items: center; gap: 8px; }
    .header .spacer { flex: 1; }
    .header img { height: 18px; display: block; }
    .section { padding: 12px; border-bottom: 1px solid #e5e7eb; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row.inline { gap: 8px; }
    .row > label { width: 84px; color: #374151; }
    input[type="text"], input[type="password"] { flex: 1; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; }
    
    .actions { display: flex; gap: 8px; }
    button { appearance: none; border: 1px solid #d1d5db; background: #f9fafb; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
    button.primary { background: #ef4444; color: white; border-color: #ef4444; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.wide { width: 100%; }
    .small { font-size: 11px; color: #6b7280; }
    .feedback { margin-top: 8px; padding: 8px; border-radius: 4px; font-size: 12px; }
    .feedback.success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
    .feedback.error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin: 8px 0 12px; }
    .tab { padding: 6px 10px; cursor: pointer; border: 1px solid transparent; border-bottom: none; background: transparent; font-weight: 600; color: #374151; }
    .tab.active { background: #ffffff; border-color: #e5e7eb; border-top-left-radius: 4px; border-top-right-radius: 4px; color: #111827; }
    .tabpane { display: none; }
    .tabpane.active { display: flex; flex-direction: column; height: 400px; }
    .tabpane-content { flex: 1; overflow: auto; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; }
    .tabpane-footer { flex-shrink: 0; }
    .empty-state { display: flex; align-items: center; justify-content: center; min-height: 200px; color: #9ca3af; font-size: 13px; }
    #preview { background: #f5f5f5; border-radius: 4px; padding: 16px; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    
    /* JSON tab with copy button */
    .json-container { position: relative; width: 100%; height: 100%; }
    .copy-btn { position: absolute; top: 8px; right: 8px; padding: 4px 8px; font-size: 11px; z-index: 10; }
    .copy-btn.copied { background: #10b981; color: white; border-color: #10b981; }
    
    /* Animated checkmark */
    .copy-check {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: bold;
      pointer-events: none;
      animation: checkPop 0.6s ease-out forwards;
      z-index: 20;
    }
    
    @keyframes checkPop {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }
      50% {
        transform: scale(1.2);
        opacity: 1;
      }
      70% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(1) translateY(-20px);
        opacity: 0;
      }
    }
  </style>
  <script>
    const VERSION = '0.1.0'
    const BUILD = 23
    let state = { apiKey: '', activeTab: 'preview', selectionData: null, sending: false, sendAs: 'element' }

    onmessage = (event) => {
      const msg = event.data.pluginMessage
      if (!msg) return
      if (msg.type === 'init') {
        state.apiKey = msg.apiKey || ''
        const inp = document.getElementById('apiKey')
        if (inp) inp.value = state.apiKey
        renderHeader()
        renderAccountSection()
      }
      if (msg.type === 'selection.full') {
        state.sendAs = inferSendType(msg.selection)
        state.selectionData = msg.selection
        renderSelection(msg.selection)
      }
    }

    // Handshake so worker can resend stored key on reload
    window.addEventListener('load', () => {
      parent.postMessage({ pluginMessage: { type: 'ui-ready' } }, '*')
      const vf = document.getElementById('versionFooter')
      if (vf) vf.textContent = `v${VERSION} • build ${BUILD}`
    })

    function save() {
      const apiKey = document.getElementById('apiKey').value.trim()
      parent.postMessage({ pluginMessage: { type: 'save-settings', apiKey } }, '*')
      state.apiKey = apiKey
      renderHeader()
      renderAccountSection()
    }

    function logout() {
      parent.postMessage({ pluginMessage: { type: 'logout' } }, '*')
      state.apiKey = ''
      const inp = document.getElementById('apiKey')
      if (inp) inp.value = ''
      renderHeader()
      renderAccountSection()
    }

    function renderHeader() {
      const btn = document.getElementById('logoutBtn')
      if (!btn) return
      btn.style.display = state.apiKey ? 'inline-flex' : 'none'
    }

    function renderAccountSection() {
      const unsaved = document.getElementById('accountUnsaved')
      const saved = document.getElementById('accountSaved')
      if (unsaved) unsaved.style.display = state.apiKey ? 'none' : 'block'
      if (saved) saved.style.display = state.apiKey ? 'block' : 'none'
    }

    // Infer an export type from the current selection
    function inferSendType(selection) {
      if (!Array.isArray(selection) || selection.length === 0) return 'element'
      if (selection.length > 1) return 'element'
      const n = selection[0] || {}
      const t = n.type
      if (t === 'COMPONENT' || t === 'INSTANCE' || t === 'COMPONENT_SET') return 'component'
      if (n.isTopLevel && (t === 'FRAME' || t === 'GROUP')) return 'page'
      return 'element'
    }

    async function sendToBetterForms() {
      if (!state.apiKey) {
        showFeedback('Please save an API key in the Account tab first.', 'error')
        return
      }
      if (!state.selectionData || state.selectionData.length === 0) {
        showFeedback('No selection to send.', 'error')
        return
      }
      state.sending = true
      renderSendButton()
      renderSendOptions()
      clearFeedback()
      try {
        const response = await fetch('https://appdev.fmbetterforms.com/api/v1/figma', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            apiKey: state.apiKey,
            type: state.sendAs,
            elementName: (state.selectionData && state.selectionData[0] && state.selectionData[0].name) ? state.selectionData[0].name : '',
            data: state.selectionData
          })
        })
        if (!response.ok) {
          let serverMsg = ''
          try {
            const ct = response.headers.get('content-type') || ''
            if (ct.includes('application/json')) {
              const errJson = await response.json()
              serverMsg = errJson && (errJson.message || errJson.error || JSON.stringify(errJson)).toString()
            } else {
              serverMsg = (await response.text()) || ''
            }
          } catch {}
          const hint = (status => {
            if (status === 401) return 'Please check your API key.'
            if (status === 403) return 'You do not have permission to perform this action.'
            if (status === 404) return 'Endpoint not found. Please update the plugin or contact support.'
            if (status === 429) return 'Rate limit exceeded. Please wait and try again.'
            if (status === 422) return 'Validation failed. Ensure your selection is valid.'
            if (status >= 500) return 'The server encountered an error. Try again later.'
            return ''
          })(response.status)
          const msg = [`Server responded with ${response.status} ${response.statusText || ''}`.trim(), serverMsg, hint].filter(Boolean).join(' — ')
          throw new Error(msg)
        }
        const result = await response.json()
        showFeedback('Successfully sent to BetterForms!', 'success')
      } catch (e) {
        showFeedback(`Failed to send: ${e.message}`, 'error')
      } finally {
        state.sending = false
        renderSendButton()
        renderSendOptions()
      }
    }

    function renderSendButton() {
      const btn = document.getElementById('sendBtn')
      if (!btn) return
      const hasSelection = state.selectionData && state.selectionData.length > 0
      btn.disabled = state.sending || !hasSelection
      const sendIcon = '<svg style="width:14px;height:14px;margin-right:6px;display:inline-block;vertical-align:middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>'
      btn.innerHTML = state.sending ? 'Sending...' : sendIcon + 'Send to BetterForms'
    }

    function renderSendOptions() {
      const container = document.getElementById('sendOptions')
      if (!container) return
      container.innerHTML = ''
      // Ensure radios align left and use a tight, consistent gap
      container.style.justifyContent = 'flex-start'
      container.style.gap = '6px'

      const label = document.createElement('label')
      label.textContent = 'Export as:'
      // Override the default .row > label width to keep label tight
      label.style.width = 'auto'
      label.style.marginRight = '6px'
      container.appendChild(label)

      const options = [
        { value: 'element', text: 'element' },
        { value: 'component', text: 'component' },
        { value: 'page', text: 'page' }
      ]
      const disabled = state.sending || !(state.selectionData && state.selectionData.length > 0)

      options.forEach(opt => {
        const wrap = document.createElement('label')
        wrap.style.display = 'inline-flex'
        wrap.style.alignItems = 'center'
        // Avoid the global .row > label width rule so radios are tight
        wrap.style.width = 'auto'
        // Rely on container gap; no extra margin between radios
        wrap.style.marginRight = '0'
        // Tighten spacing between the radio control and its text
        wrap.style.gap = '1px'

        const input = document.createElement('input')
        input.type = 'radio'
        input.name = 'sendAs'
        input.value = opt.value
        input.checked = state.sendAs === opt.value
        input.disabled = disabled
        input.onchange = () => { state.sendAs = opt.value }

        const text = document.createElement('span')
        text.textContent = opt.text

        wrap.appendChild(input)
        wrap.appendChild(text)
        container.appendChild(wrap)
      })
    }

    function showFeedback(message, type) {
      const fb = document.getElementById('sendFeedback')
      if (!fb) return
      fb.textContent = message
      fb.className = `feedback ${type}`
      fb.style.display = 'block'
    }

    function clearFeedback() {
      const fb = document.getElementById('sendFeedback')
      if (fb) fb.style.display = 'none'
    }

    function copyJsonToClipboard() {
      if (!state.selectionData || state.selectionData.length === 0) return
      const jsonString = JSON.stringify(state.selectionData, null, 2)
      
      // Use textarea fallback for Figma plugin environment
      const textarea = document.createElement('textarea')
      textarea.value = jsonString
      textarea.style.position = 'fixed'
      textarea.style.opacity = '0'
      document.body.appendChild(textarea)
      textarea.select()
      
      try {
        document.execCommand('copy')
        const btn = document.getElementById('copyBtn')
        const jsonEl = document.getElementById('json')
        
        // Show animated checkmark
        if (jsonEl) {
          const check = document.createElement('div')
          check.className = 'copy-check'
          check.textContent = '✓'
          jsonEl.appendChild(check)
          
          // Remove after animation completes
          setTimeout(() => {
            check.remove()
          }, 600)
        }
        
        // Update button temporarily
        if (btn) {
          btn.classList.add('copied')
          btn.textContent = '✓ Copied!'
          setTimeout(() => {
            btn.classList.remove('copied')
            btn.textContent = 'Copy JSON'
          }, 2000)
        }
      } catch (err) {
        console.error('Failed to copy:', err)
      } finally {
        document.body.removeChild(textarea)
      }
    }

    function renderSelection(selection) {
      const meta = document.getElementById('selMeta')
      const jsonEl = document.getElementById('json')
      const previewEl = document.getElementById('preview')
      clearFeedback()
      if (!Array.isArray(selection) || selection.length === 0) {
        if (meta) meta.textContent = 'No selection'
        if (jsonEl) {
          jsonEl.innerHTML = '<div class="empty-state">Select a layer or object to view JSON data</div>'
        }
        if (previewEl) {
          previewEl.innerHTML = '<div class="empty-state">Select a layer or object to preview</div>'
        }
        renderSendButton()
        renderSendOptions()
        return
      }
      const first = selection[0]
      if (meta) meta.textContent = `${selection.length} node(s): ${first.name} (${first.type})`
      // Render JSON with copy button
      try {
        jsonEl.innerHTML = ''
        jsonEl.style.position = 'relative'
        
        // Copy button
        const copyBtn = document.createElement('button')
        copyBtn.id = 'copyBtn'
        copyBtn.className = 'copy-btn'
        copyBtn.textContent = 'Copy JSON'
        copyBtn.onclick = copyJsonToClipboard
        
        // JSON pre element
        const pre = document.createElement('pre')
        pre.textContent = JSON.stringify(selection, null, 2)
        pre.style.fontFamily = 'ui-monospace, SFMono-Regular, Menlo, monospace'
        pre.style.fontSize = '11px'
        pre.style.background = '#f9fafb'
        pre.style.border = '1px solid #e5e7eb'
        pre.style.borderRadius = '4px'
        pre.style.padding = '8px'
        pre.style.paddingTop = '32px'
        pre.style.margin = '0'
        pre.style.overflowX = 'auto'
        
        jsonEl.appendChild(copyBtn)
        jsonEl.appendChild(pre)
        if (previewEl) {
          previewEl.innerHTML = ''
          if (first.previewUrl) {
            const img = document.createElement('img')
            img.src = first.previewUrl
            // Display high-res export centered and filling the panel
            img.style.maxWidth = '100%'
            img.style.maxHeight = '100%'
            img.style.width = 'auto'
            img.style.height = 'auto'
            img.style.objectFit = 'contain'
            img.style.display = 'block'
            img.style.margin = 'auto'
            img.style.borderRadius = '4px'
            img.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05)'
            previewEl.appendChild(img)
          } else {
            const p = document.createElement('div')
            p.className = 'empty-state'
            p.textContent = 'No preview available for this node.'
            previewEl.appendChild(p)
          }
        }
      } catch (e) {
        console.error('Error rendering selection:', e)
        jsonEl.textContent = String(e)
      }

      // Ensure correct tab visibility after content updates
      applyActiveTab()
      renderSendButton()
      renderSendOptions()
    }

    function setActiveTab(tab) {
      state.activeTab = tab
      applyActiveTab()
    }

    function applyActiveTab() {
      const tabs = document.querySelectorAll('.tab')
      tabs.forEach(t => {
        const isActive = t.dataset.tab === state.activeTab
        t.classList.toggle('active', isActive)
      })
      const panes = document.querySelectorAll('.tabpane')
      panes.forEach(p => {
        const isActive = p.dataset.tab === state.activeTab
        p.classList.toggle('active', isActive)
      })
    }
  </script>
</head>
<body>

  <div class="section" id="devSection">
    <div class="tabs">
      <button class="tab active" data-tab="preview" onclick="setActiveTab('preview')">Preview</button>
      <button class="tab" data-tab="json" onclick="setActiveTab('json')">JSON</button>
      <button class="tab" data-tab="account" style="margin-left:auto" onclick="setActiveTab('account')">Account</button>
    </div>
    <div class="tabpanes">
      <div class="tabpane active" data-tab="preview">
        <div class="tabpane-content">
          <div id="preview"></div>
        </div>
        <div class="tabpane-footer">
          <div id="sendOptions" class="row inline" style="margin-bottom:8px; padding-bottom:6px;"></div>
          <button id="sendBtn" class="primary wide" onclick="sendToBetterForms()">Send to BetterForms</button>
          <div id="sendFeedback" class="feedback" style="display:none;"></div>
        </div>
      </div>
      <div class="tabpane" data-tab="json">
        <div class="tabpane-content">
          <div id="json" style="width: 100%; height: 100%;"></div>
        </div>
      </div>
      <div class="tabpane" data-tab="account">
        <div class="tabpane-content" style="display:block; padding:16px;">
          <div id="accountUnsaved">
            <div style="margin-bottom:16px;">
              <strong style="font-size:13px; display:block; margin-bottom:8px;">Connect to BetterForms</strong>
              <p class="small" style="margin:0 0 12px 0; line-height:1.5;">
                To sync designs with BetterForms, you need an API key from your BetterForms account.
              </p>
              <p class="small" style="margin:0 0 12px 0; line-height:1.5;">
                <strong>How to get your API key:</strong><br>
                1. Open the FileMaker BetterForms Editor<br>
                2. Go to <strong>Account / Users</strong> tab<br>
                3. Copy your API key
              </p>
            </div>
            <div class="row inline" style="margin-bottom:8px;">
              <label for="apiKey">API key</label>
              <input id="apiKey" type="password" placeholder="Paste BF API key" />
              <button class="primary" onclick="save()">Save</button>
            </div>
            <div class="small" style="margin-top:8px;">Stored securely per‑user via clientStorage.</div>
          </div>
          <div id="accountSaved" style="display:none;">
            <div style="padding:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:4px; margin-bottom:12px;">
              <div class="small" style="color:#065f46;">✓ API key connected</div>
            </div>
            <div class="row" style="justify-content:flex-end;">
              <button id="logoutBtn" onclick="logout()">Logout</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="section" id="footer">
    <div class="small" id="versionFooter"></div>
  </div>
</body>
</html>


