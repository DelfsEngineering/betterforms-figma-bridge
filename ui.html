<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BetterForms Figma Bridge</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font: 12px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: #111827; }
    .header { background: #ffffff; border-bottom: 1px solid #e5e7eb; padding: 12px; display: flex; align-items: center; gap: 8px; }
    .header .spacer { flex: 1; }
    .header img { height: 18px; display: block; }
    .section { padding: 12px; border-bottom: 1px solid #e5e7eb; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row.inline { gap: 8px; }
    .row > label { width: 84px; color: #374151; }
    input[type="text"], input[type="password"] { flex: 1; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; }
    
    .actions { display: flex; gap: 8px; }
    button { appearance: none; border: 1px solid #d1d5db; background: #f9fafb; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
    button.primary { background: #ef4444; color: white; border-color: #ef4444; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.wide { width: 100%; }
    .small { font-size: 11px; color: #6b7280; }
    .feedback { margin-top: 8px; padding: 8px; border-radius: 4px; font-size: 12px; }
    .feedback.success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
    .feedback.error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin: 8px 0 12px; }
    .tab { padding: 6px 10px; cursor: pointer; border: 1px solid transparent; border-bottom: none; background: transparent; font-weight: 600; color: #374151; }
    .tab.active { background: #ffffff; border-color: #e5e7eb; border-top-left-radius: 4px; border-top-right-radius: 4px; color: #111827; }
    .tabpane { display: none; }
    .tabpane.active { display: flex; flex-direction: column; height: 400px; }
    .tabpane-content { flex: 1; overflow: auto; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; }
    .tabpane-footer { flex-shrink: 0; }
    .empty-state { display: flex; align-items: center; justify-content: center; min-height: 200px; color: #9ca3af; font-size: 13px; }
    #preview { background: #f5f5f5; border-radius: 4px; padding: 16px; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
  </style>
  <script>
    let state = { apiKey: '', activeTab: 'preview', selectionData: null, sending: false }

    onmessage = (event) => {
      const msg = event.data.pluginMessage
      if (!msg) return
      if (msg.type === 'init') {
        state.apiKey = msg.apiKey || ''
        const inp = document.getElementById('apiKey')
        if (inp) inp.value = state.apiKey
        renderHeader()
        renderAccountSection()
      }
      if (msg.type === 'selection.full') {
        state.selectionData = msg.selection
        renderSelection(msg.selection)
      }
    }

    // Handshake so worker can resend stored key on reload
    window.addEventListener('load', () => {
      parent.postMessage({ pluginMessage: { type: 'ui-ready' } }, '*')
    })

    function save() {
      const apiKey = document.getElementById('apiKey').value.trim()
      parent.postMessage({ pluginMessage: { type: 'save-settings', apiKey } }, '*')
      state.apiKey = apiKey
      renderHeader()
      renderAccountSection()
    }

    function logout() {
      parent.postMessage({ pluginMessage: { type: 'logout' } }, '*')
      state.apiKey = ''
      const inp = document.getElementById('apiKey')
      if (inp) inp.value = ''
      renderHeader()
      renderAccountSection()
    }

    function renderHeader() {
      const btn = document.getElementById('logoutBtn')
      if (!btn) return
      btn.style.display = state.apiKey ? 'inline-flex' : 'none'
    }

    function renderAccountSection() {
      const unsaved = document.getElementById('accountUnsaved')
      const saved = document.getElementById('accountSaved')
      if (unsaved) unsaved.style.display = state.apiKey ? 'none' : 'block'
      if (saved) saved.style.display = state.apiKey ? 'block' : 'none'
    }

    async function sendToBetterForms() {
      if (!state.apiKey) {
        showFeedback('Please save an API key in the Account tab first.', 'error')
        return
      }
      if (!state.selectionData || state.selectionData.length === 0) {
        showFeedback('No selection to send.', 'error')
        return
      }
      state.sending = true
      renderSendButton()
      clearFeedback()
      try {
        const response = await fetch('https://appdev.fmbetterforms.com/api/figma', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            apiKey: state.apiKey,
            data: state.selectionData
          })
        })
        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`)
        }
        const result = await response.json()
        showFeedback('Successfully sent to BetterForms!', 'success')
      } catch (e) {
        showFeedback(`Failed to send: ${e.message}`, 'error')
      } finally {
        state.sending = false
        renderSendButton()
      }
    }

    function renderSendButton() {
      const btn = document.getElementById('sendBtn')
      if (!btn) return
      const hasSelection = state.selectionData && state.selectionData.length > 0
      btn.disabled = state.sending || !hasSelection
      btn.textContent = state.sending ? 'Sending...' : 'Send to BetterForms'
    }

    function showFeedback(message, type) {
      const fb = document.getElementById('sendFeedback')
      if (!fb) return
      fb.textContent = message
      fb.className = `feedback ${type}`
      fb.style.display = 'block'
    }

    function clearFeedback() {
      const fb = document.getElementById('sendFeedback')
      if (fb) fb.style.display = 'none'
    }

    function renderSelection(selection) {
      const meta = document.getElementById('selMeta')
      const jsonEl = document.getElementById('json')
      const previewEl = document.getElementById('preview')
      clearFeedback()
      if (!Array.isArray(selection) || selection.length === 0) {
        if (meta) meta.textContent = 'No selection'
        if (jsonEl) jsonEl.textContent = ''
        if (previewEl) {
          previewEl.innerHTML = '<div class="empty-state">Select a layer or object to preview</div>'
        }
        renderSendButton()
        return
      }
      const first = selection[0]
      if (meta) meta.textContent = `${selection.length} node(s): ${first.name} (${first.type})`
      // Render a collapsible JSON tree (simple)
      try {
        jsonEl.innerHTML = ''
        const pre = document.createElement('pre')
        pre.textContent = JSON.stringify(selection, null, 2)
        jsonEl.appendChild(pre)
        if (previewEl) {
          previewEl.innerHTML = ''
          if (first.previewUrl) {
            const img = document.createElement('img')
            img.src = first.previewUrl
            img.style.maxWidth = '100%'
            img.style.maxHeight = '100%'
            img.style.borderRadius = '4px'
            img.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05)'
            img.style.display = 'block'
            previewEl.appendChild(img)
          } else {
            const p = document.createElement('div')
            p.className = 'empty-state'
            p.textContent = 'No preview available for this node.'
            previewEl.appendChild(p)
          }
        }
      } catch (e) {
        console.error('Error rendering selection:', e)
        jsonEl.textContent = String(e)
      }

      // Ensure correct tab visibility after content updates
      applyActiveTab()
      renderSendButton()
    }

    function setActiveTab(tab) {
      state.activeTab = tab
      applyActiveTab()
    }

    function applyActiveTab() {
      const tabs = document.querySelectorAll('.tab')
      tabs.forEach(t => {
        const isActive = t.dataset.tab === state.activeTab
        t.classList.toggle('active', isActive)
      })
      const panes = document.querySelectorAll('.tabpane')
      panes.forEach(p => {
        const isActive = p.dataset.tab === state.activeTab
        p.classList.toggle('active', isActive)
      })
    }
  </script>
</head>
<body>
  <div class="header">
    <strong>BetterForms Figma Bridge</strong>
    <div class="spacer"></div>
  </div>
  <div class="section" id="devSection">
    <div class="tabs">
      <button class="tab active" data-tab="preview" onclick="setActiveTab('preview')">Preview</button>
      <button class="tab" data-tab="json" onclick="setActiveTab('json')">JSON</button>
      <button class="tab" data-tab="account" style="margin-left:auto" onclick="setActiveTab('account')">Account</button>
    </div>
    <div class="tabpanes">
      <div class="tabpane active" data-tab="preview">
        <div class="tabpane-content">
          <div id="preview"></div>
        </div>
        <div class="tabpane-footer">
          <button id="sendBtn" class="primary wide" onclick="sendToBetterForms()">Send to BetterForms</button>
          <div id="sendFeedback" class="feedback" style="display:none;"></div>
        </div>
      </div>
      <div class="tabpane" data-tab="json">
        <div class="tabpane-content">
          <div id="json" style="font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:11px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:4px; padding:8px;"></div>
        </div>
      </div>
      <div class="tabpane" data-tab="account">
        <div class="tabpane-content" style="display:block; padding:16px;">
          <div id="accountUnsaved">
            <div style="margin-bottom:16px;">
              <strong style="font-size:13px; display:block; margin-bottom:8px;">Connect to BetterForms</strong>
              <p class="small" style="margin:0 0 12px 0; line-height:1.5;">
                To sync designs with BetterForms, you need an API key from your BetterForms account.
              </p>
              <p class="small" style="margin:0 0 12px 0; line-height:1.5;">
                <strong>How to get your API key:</strong><br>
                1. Open the FileMaker BetterForms Editor<br>
                2. Go to <strong>Account / Users</strong> tab<br>
                3. Copy your API key
              </p>
            </div>
            <div class="row inline" style="margin-bottom:8px;">
              <label for="apiKey">API key</label>
              <input id="apiKey" type="password" placeholder="Paste BF API key" />
              <button class="primary" onclick="save()">Save</button>
            </div>
            <div class="small" style="margin-top:8px;">Stored securely per‑user via clientStorage.</div>
          </div>
          <div id="accountSaved" style="display:none;">
            <div style="padding:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:4px; margin-bottom:12px;">
              <div class="small" style="color:#065f46;">✓ API key connected</div>
            </div>
            <div class="row" style="justify-content:flex-end;">
              <button id="logoutBtn" onclick="logout()">Logout</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>


